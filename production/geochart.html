<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Google Visualization API Sample</title>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="/js/ajax_config.js"></script>
  <script type="text/javascript" src="/js/jquery.js"></script>
  <script language="javascript" src="/js/jquery.cookie.js"></script>
  <script type="text/javascript">
	// load visualization library
    google.load('visualization', '1', {packages: ['geochart']});
    
    function formatDate(unixTimestamp) {
        if (unixTimestamp == null) return null;
        var dt = new Date(parseInt(unixTimestamp));
        // alert()
        var day = dt.getDate();
        var month = dt.getMonth()+1;
        var year = dt.getFullYear();
    
        /*alert(day);
         alert(month);
         alert(year);
         */
        // the above dt.get...() functions return a single digit
        // so I prepend the zero here when needed
        if (day < 10)
            day = '0' + day;
    
        if (month < 10)
            month = '0' + month;
    
        //alert (day + "." + month + "." + year);
        return day + "." + month + "." + year;
    }
    
    $(function() {
    		// when document loads, grab the json

			var loc = location.href.split('#');
			id = loc[loc.length - 1];
			//alert(id);
            
            //даты
            
            var dstart = formatDate($.cookie(id+"-fromDate-theme"));
            var dend = formatDate($.cookie(id+"-toDate-theme"));

            //даты
            
			$.postJSON(ajaxURL_Filters,{order_id: id, start: dstart, end: dend}, function(data) {
				// once grabbed, we run this callback
				//alert(data);
				// setup the new map and its variables
				//len=(data.params.city.length>map_cities_count)?map_cities_count:data.params.city.length;
        len=data.params.city.length;
        map_cities_count=len;
        console.log(len);
				var map = new google.visualization.DataTable();
					map.addRows(len);  // length gives us the number of results in our returned data
					map.addColumn('string', 'Город');
	      			map.addColumn('number', 'Сообщения');
	      		
				// now we need to build the map data, loop over each result
				//$.each(data.city, function(i,v) {
					// set the values for both the name and the population
				//	map.setValue(i, 0, v.name);
				//	map.setValue(i, 1, v.count);
				//});
				 console.log(data.params.city);
				$(data.params.city).each(function(index, element) {
					//alert(element.name+' '+element.count);
          console.log(data.params.city[index]);
					map.setValue(index, 0, element.name);
					map.setValue(index, 1, element.count);
					if (index==map_cities_count-1) return false;
			    });

                
				var options = {
					region: '151',
          height: '291',
          width: '476',
					displayMode: 'markers',
					colorAxis: {colors: ['#99C492', '#AD6D6D']},
					sizeAxis: {minSize: 10, maxSize: 30}
			 	};
				
				// finally, create the map!
				var geomap = new google.visualization.GeoChart(
		          document.getElementById('visualization'));
		     		 geomap.draw(map, options);
                     //обработка нажатия для применения фильтра
                     google.visualization.events.addListener(geomap, 'select', selectHandler);
                 function selectHandler(e) {
                    var selection = geomap.getSelection();
                    var row=selection[0].row;
                    $.cookie(id+'-cities-msg', map.getValue(row,0)); 
                    window.parent.location.href = 'messages_list.html#'+id;
                    //alert('You selected '  + map.getValue(row,0));
                 }

			});
   });
  </script>
</head>
<body style="font-family: Arial;border: 0 none;">
<div id="visualization" style="display:block; position:absolute; top:0; left:0; width:100%; height:100%;"></div>
</body>
</html>